<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/favicon.ico"/><meta name="description" content="Blog about software engineering, management, and other interesting thoughts"/><meta name="og:title" content="Reyan Blog"/><link rel="preload" as="image" imagesrcset="/_next/image?url=%2Fimages%2Fscene.jpeg&amp;w=128&amp;q=75 1x, /_next/image?url=%2Fimages%2Fscene.jpeg&amp;w=256&amp;q=75 2x"/><title>File Search Tool</title><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/ec97798b16123a88.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ec97798b16123a88.css" data-n-g=""/><link rel="preload" href="/_next/static/css/ca2a5f0cc0e0175b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/ca2a5f0cc0e0175b.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-d7b038a63b619762.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-1038209226d7adb4.js" defer=""></script><script src="/_next/static/chunks/pages/_app-67d2bc72b78694d0.js" defer=""></script><script src="/_next/static/chunks/78-bdfdf4d064184fb9.js" defer=""></script><script src="/_next/static/chunks/688-564d5ce4fce97f19.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bid%5D-01cab840522437f1.js" defer=""></script><script src="/_next/static/uzSFrkBCaZp2MnXn1GAEW/_buildManifest.js" defer=""></script><script src="/_next/static/uzSFrkBCaZp2MnXn1GAEW/_ssgManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div class="theme-light_themeWrapper__bvKnI"><div class="layout_container__fbLkO"><div class="toggle_toggle__dvuTg"><div class="toggle_toggleContainer__K3RPH"><div class="toggle_toggleCheck__xUj3r"><span>üåú</span></div><div class="toggle_toggleUncheck__VtG_u"><span>üåû</span></div></div><div class="toggle_toggleCircle__42TBJ"></div><input type="checkbox" aria-label="Toggle Button" class="toggle_toggleInput___RU7f"/></div><header class="layout_header__kY0Lt"><a href="/"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%27108%27%20height=%27108%27/%3e"/></span><img alt="Luculent Lollygag" srcSet="/_next/image?url=%2Fimages%2Fscene.jpeg&amp;w=128&amp;q=75 1x, /_next/image?url=%2Fimages%2Fscene.jpeg&amp;w=256&amp;q=75 2x" src="/_next/image?url=%2Fimages%2Fscene.jpeg&amp;w=256&amp;q=75" decoding="async" data-nimg="intrinsic" class="utils_borderCircle__s2nTm" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></span></a><h2 class="utils_headingLg__5535D"><a class="utils_colorInherit__mSH_x" href="/">Luculent Lollygag</a></h2></header><main><article><h1 class="utils_headingXl__u25Y2">File Search Tool</h1><div class="utils_lightText__eUzGY"><time dateTime="2021-04-29">29 Apr 2021</time></div><div><h1>File Search Tool</h1>
<p>I ran into a deep babel issue where file output was a problem under a specific set of circumstances: the module was AMD and it included a class that extends <code>React.Component</code>. I didn't know how pervasive the problem was in the codebase I was working in which a quick</p>
<p><code>find . -type f | wc -l</code></p>
<p>told me there was 42247 files.</p>
<p>So what I needed was to grep through all the files looking for a set of specific terms</p>
<pre><code>['Component {', 'define(', 'class', 'React']
</code></pre>
<p>This may not be fool proof but would pretty much get me what I want. After a few minutes of poking around, I figured I'd either need to write an extremely complex perl regex, or a full bash script. As I'm not great at either of these and I was running short on time I decided to give a shot throwing together a node script instead. And I was very pleased with how quickly I could get up a result!</p>
<p>Here's exactly what I did:</p>
<pre><code class="language-sh">mkcd search-terms-tool
</code></pre>
<p>mkcd is my alias to make a directory and go into it immediately: <code>mkcd () { mkdir "$1" &#x26;&#x26; cd $_ }</code></p>
<pre><code class="language-sh">yarn init
yarn add fast-glob
</code></pre>
<p>We'll need fast-glob to find all the file paths easily. Optionally you can add <code>yargs</code> to read the path to search from the command line. I was under time pressure so I just put it in the code directly.</p>
<pre><code class="language-sh">touch index.js
</code></pre>
<p>Open your editor of choice. Mine is vscode. Like I said above, first we need to get all the JS files in the directory:</p>
<pre><code class="language-javascript">const fg = require('fast-glob');

const SEARCH_DIR = '/path/to/code';
const paths = fg.sync(`${SEARCH_DIR}/**/*.js`);

console.log(paths);
</code></pre>
<p>Then run the code or fire up <code>nodemon</code> if you want things to auto run:</p>
<pre><code class="language-sh">node index.js
</code></pre>
<p>You should see a huge list of files! This was basically one line of running code and we're half way there. Now we just need to filter by those containing all the search terms. The easiest way I could think of is to read the contents of each file using nodes build-in <code>fs</code>, then <code>.filter</code> by looking at <code>.every</code> search term:</p>
<pre><code class="language-javascript">const fs = require('fs');
const fg = require('fast-glob');

const searchTerms = ['Component {', 'define(', 'class', 'React'];

const SEARCH_DIR = '/path/to/code';
const paths = fg.sync(`${SEARCH_DIR}/**/*.js`);

const validPaths = paths.filter(path => {
  const contents = fs.readFileSync(path);
  return searchTerms.every(term => {
    return contents.includes(term);
  });
});

console.log(validPaths);
</code></pre>
<p>And that's it! I was pretty floored by how quickly I could throw this together. And since I had some extra time, I decided to make two upgrades: run the file reads in parallel, and write the results to a file.</p>
<p>Simple enough - build a list of promises and run <code>Promise.all</code> to get the filtered results:</p>
<pre><code class="language-javascript">const util = require('util');

const readFile = util.promisify(fs.readFile);

const readAndCheckFile = async (path) => {
  const contents = await readFile(path);
  return searchTerms.every(term => contents.includes(term));
}

const printResults = validPaths =>
  fs.writeFileSync('./results.txt', validPaths.join('\n'));

Promise.all(paths.filter(readAndCheckFile)).catch(console.log).then(printResults);
</code></pre>
<p>The initial run I didn't have the <code>.catch</code> on the last line and the program blew up üò¨</p>
<p>After adding the <code>.catch</code> I found a "too many files open" error. After a quick google search I found <code>graceful-fs</code> which waits if it encounters an error. After simply changing the import it worked! Here's the final program I went with:</p>
<pre><code class="language-javascript">const fs = require('graceful-fs');
const fg = require('fast-glob');
const util = require('util');

// Convert fs.readFile into Promise version of same
const readFile = util.promisify(fs.readFile);

// path to find files in (no trailing slash)
const SEARCH_DIR = '/path/to/code';

// order these by what will filter the most to least
const searchTerms = ['Component {', 'define(', 'class', 'React'];

// find all the paths to files to look in
const paths = fg.sync(`${SEARCH_DIR}/**/*.js`);

const readAndCheckFile = async path => {
  const contents = await readFile(path);
  // check if all the terms are in the file contents
  return searchTerms.every(term => contents.includes(term));
};

const printResults = validPaths =>
  fs.writeFileSync('./results.txt', validPaths.join('\n'));

Promise.all(paths.filter(path => readAndCheckFile(path)))
  .catch(err => console.log(err))
  .then(printResults)
  .then(() => console.log('SUCCESS!'));
</code></pre>
<p>For someone completely unfamiliar with node and the JS ecosystem this could have been a nightmare and they probably would have figured out the bash regex path. If you know that path PLEASE let me know! But I guess the lesson here is to not be afraid to use the tools you already know and love. This helped me avoid a rabbit hole and I got my fix out on time.</p>
<p>Happy Coding!</p></div></article><button style="font-size:1.4em;background:none;border:none;cursor:pointer">üëç</button></main><div class="layout_backToHome__9sjx_"><a href="/">‚Üê Back to home</a></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"04-29-file-search-tool","contentHtml":"\u003ch1\u003eFile Search Tool\u003c/h1\u003e\n\u003cp\u003eI ran into a deep babel issue where file output was a problem under a specific set of circumstances: the module was AMD and it included a class that extends \u003ccode\u003eReact.Component\u003c/code\u003e. I didn't know how pervasive the problem was in the codebase I was working in which a quick\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003efind . -type f | wc -l\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003etold me there was 42247 files.\u003c/p\u003e\n\u003cp\u003eSo what I needed was to grep through all the files looking for a set of specific terms\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e['Component {', 'define(', 'class', 'React']\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis may not be fool proof but would pretty much get me what I want. After a few minutes of poking around, I figured I'd either need to write an extremely complex perl regex, or a full bash script. As I'm not great at either of these and I was running short on time I decided to give a shot throwing together a node script instead. And I was very pleased with how quickly I could get up a result!\u003c/p\u003e\n\u003cp\u003eHere's exactly what I did:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003emkcd search-terms-tool\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003emkcd is my alias to make a directory and go into it immediately: \u003ccode\u003emkcd () { mkdir \"$1\" \u0026#x26;\u0026#x26; cd $_ }\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003eyarn init\nyarn add fast-glob\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe'll need fast-glob to find all the file paths easily. Optionally you can add \u003ccode\u003eyargs\u003c/code\u003e to read the path to search from the command line. I was under time pressure so I just put it in the code directly.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003etouch index.js\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eOpen your editor of choice. Mine is vscode. Like I said above, first we need to get all the JS files in the directory:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst fg = require('fast-glob');\n\nconst SEARCH_DIR = '/path/to/code';\nconst paths = fg.sync(`${SEARCH_DIR}/**/*.js`);\n\nconsole.log(paths);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThen run the code or fire up \u003ccode\u003enodemon\u003c/code\u003e if you want things to auto run:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-sh\"\u003enode index.js\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eYou should see a huge list of files! This was basically one line of running code and we're half way there. Now we just need to filter by those containing all the search terms. The easiest way I could think of is to read the contents of each file using nodes build-in \u003ccode\u003efs\u003c/code\u003e, then \u003ccode\u003e.filter\u003c/code\u003e by looking at \u003ccode\u003e.every\u003c/code\u003e search term:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst fs = require('fs');\nconst fg = require('fast-glob');\n\nconst searchTerms = ['Component {', 'define(', 'class', 'React'];\n\nconst SEARCH_DIR = '/path/to/code';\nconst paths = fg.sync(`${SEARCH_DIR}/**/*.js`);\n\nconst validPaths = paths.filter(path =\u003e {\n  const contents = fs.readFileSync(path);\n  return searchTerms.every(term =\u003e {\n    return contents.includes(term);\n  });\n});\n\nconsole.log(validPaths);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAnd that's it! I was pretty floored by how quickly I could throw this together. And since I had some extra time, I decided to make two upgrades: run the file reads in parallel, and write the results to a file.\u003c/p\u003e\n\u003cp\u003eSimple enough - build a list of promises and run \u003ccode\u003ePromise.all\u003c/code\u003e to get the filtered results:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst util = require('util');\n\nconst readFile = util.promisify(fs.readFile);\n\nconst readAndCheckFile = async (path) =\u003e {\n  const contents = await readFile(path);\n  return searchTerms.every(term =\u003e contents.includes(term));\n}\n\nconst printResults = validPaths =\u003e\n  fs.writeFileSync('./results.txt', validPaths.join('\\n'));\n\nPromise.all(paths.filter(readAndCheckFile)).catch(console.log).then(printResults);\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe initial run I didn't have the \u003ccode\u003e.catch\u003c/code\u003e on the last line and the program blew up üò¨\u003c/p\u003e\n\u003cp\u003eAfter adding the \u003ccode\u003e.catch\u003c/code\u003e I found a \"too many files open\" error. After a quick google search I found \u003ccode\u003egraceful-fs\u003c/code\u003e which waits if it encounters an error. After simply changing the import it worked! Here's the final program I went with:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-javascript\"\u003econst fs = require('graceful-fs');\nconst fg = require('fast-glob');\nconst util = require('util');\n\n// Convert fs.readFile into Promise version of same\nconst readFile = util.promisify(fs.readFile);\n\n// path to find files in (no trailing slash)\nconst SEARCH_DIR = '/path/to/code';\n\n// order these by what will filter the most to least\nconst searchTerms = ['Component {', 'define(', 'class', 'React'];\n\n// find all the paths to files to look in\nconst paths = fg.sync(`${SEARCH_DIR}/**/*.js`);\n\nconst readAndCheckFile = async path =\u003e {\n  const contents = await readFile(path);\n  // check if all the terms are in the file contents\n  return searchTerms.every(term =\u003e contents.includes(term));\n};\n\nconst printResults = validPaths =\u003e\n  fs.writeFileSync('./results.txt', validPaths.join('\\n'));\n\nPromise.all(paths.filter(path =\u003e readAndCheckFile(path)))\n  .catch(err =\u003e console.log(err))\n  .then(printResults)\n  .then(() =\u003e console.log('SUCCESS!'));\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eFor someone completely unfamiliar with node and the JS ecosystem this could have been a nightmare and they probably would have figured out the bash regex path. If you know that path PLEASE let me know! But I guess the lesson here is to not be afraid to use the tools you already know and love. This helped me avoid a rabbit hole and I got my fix out on time.\u003c/p\u003e\n\u003cp\u003eHappy Coding!\u003c/p\u003e","title":"File Search Tool","date":"2021-04-29"}},"__N_SSG":true},"page":"/[id]","query":{"id":"04-29-file-search-tool"},"buildId":"uzSFrkBCaZp2MnXn1GAEW","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>